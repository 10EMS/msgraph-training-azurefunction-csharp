<!-- markdownlint-disable MD002 MD041 -->

In this exercise you will finish implementing the Web API Azure Functions `SetSubscription` and `Notify`, and udpate the command-line test application to subscribe and unsubscribe to changes in a user's inbox.

- The `SetSubscription` function will act as a Web API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.
- The `Notify` function will act as the webhook that receives change notifications generated by the subscription.

Both function will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph. Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.

> [!TIP]
> For simplicity's sake, the `SetSubscription` function won't require any authentication to call it. In a production scenario, you should require authentication and ensure that only authorized individuals or applications are invoking the API.

## Add client credentials authentication to the Azure Functions project

In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.

1. Open your CLI in the directory that contains **GraphTutorial.csproj**.

1. Add your webhook application ID and secret to the secret store using the following commands. Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**. Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### Create a client credentials authentication provider

1. Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

## Implement Notify function

In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.

1. Create a new directory in the **GraphTutorials** directory named **Models**.

1. Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. Create a new file in the **Models** directory named **ChangeNotification.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotification.cs" id="ChangeNotificationSnippet":::

1. Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

Consider what this code is doing.

- The `Notify` function checks for the presence of a `validationToken` query parameter. If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.
- If the request is not a validation request, the JSON payload is deserialized into a `NotificationList`.
- Each notification in the list is checked for the expected client state value, and is processed.
- The message that triggered the notification is retrieved with Microsoft Graph.

## Implement SetSubscription function

In this section, you'll implement the SetSubscription function. This function will act as a Web API that is called by the test application to create or delete a subscription on a user's inbox.

1. Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

## Call SetSubscription from the test app

In this section, you'll implement the `CreateSubscription` and `DeleteSubscription` functions to create and delete subscriptions.

1. Open **./InvokeAzureFunction/Program.cs** and replace the existing `CreateSubscription` function with the following.

    :::code language="csharp" source="../demo/InvokeAzureFunction/Program.cs" id="CreateSubscriptionSnippet":::

1. Replace the existing `DeleteSubscription` function with the following.

    :::code language="csharp" source="../demo/InvokeAzureFunction/Program.cs" id="DeleteSubscriptionSnippet":::

1. If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.

1. Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.

    ```Shell
    func start
    ```

1. Open a separate CLI window and change the current directory to the **./InvokeAzureFunction** directory. Run the following command to run the test application.

    ```Shell
    dotnet run
    ```

1. When prompted for the ngrok URL, enter your HTTPS ngrok URL from the currently running ngrok window.

1. Choose **2. Subscribe to notifications in a user's inbox**. When prompted, enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox. This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`.

1. The application displays the JSON representation of the new subscription. Copy the `id` property.

    ```json
    {
      "resource": "/users/meganb@contoso.com/mailfolders/inbox/messages",
      "changeType": "created,updated",
      "clientState": "GraphTutorialState",
      "notificationUrl": "https://418ead6a47a6.ngrok.io/api/Notify",
      "expirationDateTime": "2020-07-10T19:16:21.6944515\u002B00:00",
      "applicationId": "af342d80-9bd1-4595-9b36-46db18472bb5",
      "creatorId": "25543028-5cbe-43f8-8d8a-9d031504a9ac",
      "latestSupportedTlsVersion": "v1_2",
      "id": "2dee9f50-13d2-44f2-b3f8-691e0498ec45",
      "@odata.type": "microsoft.graph.subscription",
      "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#subscriptions/$entity",
      "responseHeaders": {
        "Cache-Control": [
          "private"
        ],
        "Location": [
          "https://subscriptionstore.windows.net/1.0/NA/subscriptions(\u00272dee9f50-13d2-44f2-b3f8-691e0498ec45\u0027)"
        ],
        "request-id": [
          "91368db4-b7a2-4265-a5ee-bfdded4a926c"
        ],
        "client-request-id": [
          "91368db4-b7a2-4265-a5ee-bfdded4a926c"
        ],
        "x-ms-ags-diagnostic": [
          "{\u0022ServerInfo\u0022:{\u0022DataCenter\u0022:\u0022South Central US\u0022,\u0022Slice\u0022:\u0022SliceC\u0022,\u0022Ring\u0022:\u00224\u0022,\u0022ScaleUnit\u0022:\u0022003\u0022,\u0022RoleInstance\u0022:\u0022AGSFE_IN_11\u0022}}"
        ],
        "OData-Version": [
          "4.0"
        ],
        "Strict-Transport-Security": [
          "max-age=31536000"
        ],
        "Date": [
          "Wed, 08 Jul 2020 19:16:23 GMT"
        ]
      },
      "statusCode": "Created"
    }
    ```

1. Send an email to the user. After a brief time, the `Notify` function should be called. You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. In the test app, choose **3. Unsubscribe to notifications in a user's inbox**. When prompted, enter the subscription ID you copied earlier. The application confirms that it deleted the subscription.
